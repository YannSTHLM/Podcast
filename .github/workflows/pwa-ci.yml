name: PWA CI

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  pwa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate PNG icons from SVG
        run: |
          mkdir -p assets/icons
          if [ -f assets/icons/icon-192.svg ]; then convert assets/icons/icon-192.svg -resize 192x192 assets/icons/icon-192.png || true; fi
          if [ -f assets/icons/icon-512.svg ]; then convert assets/icons/icon-512.svg -resize 512x512 assets/icons/icon-512.png || true; fi

      - name: Stage generated icons
        run: |
          git add assets/icons/icon-192.png assets/icons/icon-512.png || true

      - name: Commit and push generated icons (uses GITHUB_TOKEN)
        run: |
          if git diff --quiet --cached; then
            echo "No generated icons to commit"
          else
            git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" commit -m "chore(pwa): generate PNG icons from SVG"
            git push --force-with-lease origin HEAD:pwa-gen-icons || echo "Push failed (likely GITHUB_TOKEN limited)"
          fi
        continue-on-error: true

      - name: Check PERSONAL_TOKEN
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          if [ -z "$PERSONAL_TOKEN" ]; then
            echo "PERSONAL_TOKEN secret not found; skipping automatic PR creation. To enable automated PRs, add a personal access token (repo scope) as the repository secret PERSONAL_TOKEN."
          else
            echo "PERSONAL_TOKEN present; CI will attempt to create PRs and push badge."
          fi

      - name: Create PR with generated icons (uses GITHUB_TOKEN by default)
        uses: peter-evans/create-pull-request@v5
        with:
          branch: pwa-gen-icons
          commit-message: "chore(pwa): generate PNG icons from SVG"
          title: "chore(pwa): generate PNG icons from SVG"
          body: "This PR adds generated PNG icons produced from SVG sources by the CI workflow."
          base: main
          labels: automated, pwa
        continue-on-error: true

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: 'https://yannsthlm.github.io/Podcast/'
          runs: 1
          artifactName: lighthouse-results

      - name: Generate Lighthouse badge and push to PR branch (uses PERSONAL_TOKEN if present)
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          npm install -g lighthouse-badges || true
          mkdir -p badges
          npx lighthouse-badges -u "https://yannsthlm.github.io/Podcast/" -o badges/ || true
          if [ -f badges/lighthouse_performance.svg ]; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git fetch origin pwa-gen-icons || true
            git checkout -b pwa-gen-icons --track origin/pwa-gen-icons 2>/dev/null || git checkout -b pwa-gen-icons 2>/dev/null || git checkout pwa-gen-icons
            git add badges/*.svg || true
            git commit -m "chore(pwa): update lighthouse badges" || echo "no changes to commit"
            if [ -n "$PERSONAL_TOKEN" ]; then
              git push "https://x-access-token:${PERSONAL_TOKEN}@github.com/${GITHUB_REPOSITORY}" pwa-gen-icons --force-with-lease || echo "push failed"
            else
              git push --force-with-lease origin pwa-gen-icons || echo "push failed (insufficient permissions)"
            fi
          else
            echo "No badge generated; skipping push."
          fi
        continue-on-error: true

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: ./.lighthouseci/**
