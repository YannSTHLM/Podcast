name: PWA CI

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  pwa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate PNG icons from SVG
        run: |
          mkdir -p assets/icons
          if [ -f assets/icons/icon-192.svg ]; then convert assets/icons/icon-192.svg -resize 192x192 assets/icons/icon-192.png || true; fi
          if [ -f assets/icons/icon-512.svg ]; then convert assets/icons/icon-512.svg -resize 512x512 assets/icons/icon-512.png || true; fi

      - name: Stage generated icons
        run: |
          git add assets/icons/icon-192.png assets/icons/icon-512.png || true

      - name: Check PERSONAL_TOKEN
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          if [ -z "$PERSONAL_TOKEN" ]; then
            echo "PERSONAL_TOKEN secret not found; skipping automatic PR creation. To enable automated PRs, add a personal access token (repo scope) as the repository secret PERSONAL_TOKEN."
          else
            echo "PERSONAL_TOKEN present; CI will attempt to create PRs and push badge."
          fi

      - name: Create PR with generated icons (requires PERSONAL_TOKEN)
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}
          branch: pwa-gen-icons
          commit-message: "chore(pwa): generate PNG icons from SVG"
          title: "chore(pwa): generate PNG icons from SVG"
          body: "This PR adds generated PNG icons produced from SVG sources by the CI workflow."
          base: main
          labels: automated, pwa
        continue-on-error: true

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: 'https://yannsthlm.github.io/Podcast/'
          lhci_version: '0.10.0'
          output: 'html'

      - name: Generate Lighthouse badge and commit (requires PERSONAL_TOKEN)
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          if [ -n "$PERSONAL_TOKEN" ]; then
            npm install -g lighthouse-badges || true
            mkdir -p badges
            npx lighthouse-badges -s ./.lighthouseci/reports -o badges/pwa-badge.svg || true
            git add badges/pwa-badge.svg || true
            git diff --quiet --cached || (git commit -m "chore(pwa): update lighthouse badge" && git push)
          else
            echo "PERSONAL_TOKEN secret not found; skipping automatic badge commit/push. Add PERSONAL_TOKEN secret if you want CI to commit generated badges."
          fi

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: ./.lighthouseci/reports
