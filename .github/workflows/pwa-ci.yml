name: PWA CI

on:
  push:
    branches: [ main ]

jobs:
  pwa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate PNG icons from SVG
        run: |
          mkdir -p assets/icons
          if [ -f assets/icons/icon-192.svg ]; then convert assets/icons/icon-192.svg -resize 192x192 assets/icons/icon-192.png || true; fi
          if [ -f assets/icons/icon-512.svg ]; then convert assets/icons/icon-512.svg -resize 512x512 assets/icons/icon-512.png || true; fi

      - name: Commit generated icons
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/icons/icon-192.png assets/icons/icon-512.png || true
          git diff --quiet --cached || (git commit -m "chore(pwa): generate PNG icons from SVG" && git push)

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: 'https://yannsthlm.github.io/Podcast/'
          lhci_version: '0.10.0'
          output: 'html'

      - name: Generate Lighthouse badge and commit
        run: |
          npm install -g lighthouse-badges || true
          mkdir -p badges
          # Attempt to create badge SVG from local report directory
          npx lighthouse-badges -s ./.lighthouseci/reports -o badges/pwa-badge.svg || true
          git add badges/pwa-badge.svg || true
          git diff --quiet --cached || (git commit -m "chore(pwa): update lighthouse badge" && git push)

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: ./.lighthouseci/reports
